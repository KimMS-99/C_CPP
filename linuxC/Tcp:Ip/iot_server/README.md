# iot_server C 코드 분석

## 1. 개요

이 프로젝트는 간단한 IoT 장치들을 위한 멀티 클라이언트 채팅 서버 및 클라이언트입니다. 주요 기능은 다음과 같습니다.

- **서버 (`iot_server.c`)**: 다중 클라이언트의 접속을 처리하고, 메시지를 중계합니다.
- **클라이언트 (`iot_client.c`)**: 서버에 접속하여 다른 클라이언트와 메시지를 주고받습니다.

서버는 `idpasswd.txt` 파일을 통해 사용자 인증을 수행하며, 각 클라이언트는 고유 ID를 가집니다. 클라이언트는 특정 ID에게 귓속말을 보내거나, 전체에게 메시지를 브로드캐스트할 수 있습니다.

## 2. `iot_server.c` - 서버 프로그램

### 주요 기능

- **클라이언트 접속 처리**: 여러 클라이언트의 동시 접속을 `accept()` 하고, 각각의 클라이언트를 별도의 스레드로 처리합니다. (`pthread_create`)
- **사용자 인증**: 클라이언트가 접속 시 보내는 ID와 비밀번호를 `idpasswd.txt` 파일과 비교하여 인증합니다.
  - 이미 접속 중인 ID는 중복 로그인을 허용하지 않습니다.
- **메시지 중계**: 클라이언트로부터 받은 메시지를 파싱하여 특정 대상(귓속말) 또는 전체(브로드캐스트)에게 전달합니다.
  - `[대상ID]메시지` 형식의 프로토콜을 사용합니다.
  - `[ALLMSG]`는 전체 메시지, `[IDLIST]`는 현재 접속자 목록 요청을 의미합니다.
- **동시성 제어**: 여러 스레드가 클라이언트 목록(`client_info`)과 클라이언트 수(`clnt_cnt`)에 동시에 접근할 때 발생할 수 있는 문제를 방지하기 위해 `pthread_mutex_t`를 사용합니다.
- **로깅**: 클라이언트의 접속, 해제, 메시지 송수신 등 주요 이벤트를 표준 출력으로 기록합니다.

### 구조체

- **`MSG_INFO`**: 메시지 정보를 담기 위한 구조체. 보내는 사람, 받는 사람, 메시지 내용 등을 포함합니다.
- **`CLIENT_INFO`**: 클라이언트 정보를 담기 위한 구조체. 파일 디스크립터(`fd`), IP 주소, ID, 비밀번호 등을 포함합니다.

### 실행 흐름

1.  `main` 함수에서 `idpasswd.txt` 파일을 읽어 허용된 클라이언트 정보를 `client_info` 배열에 저장합니다.
2.  서버 소켓을 생성(`socket`)하고, 주소를 바인딩(`bind`)한 후, 연결 요청을 대기(`listen`)합니다.
3.  `accept()`를 통해 클라이언트의 연결 요청을 수락합니다.
4.  클라이언트로부터 ID/PW 정보를 수신하여 `client_info` 배열의 정보와 일치하는지 확인합니다.
5.  인증에 성공하면, 해당 클라이언트를 위한 새로운 스레드(`clnt_connection`)를 생성하고 클라이언트 정보를 인자로 넘겨줍니다.
6.  `clnt_connection` 스레드는 클라이언트로부터 메시지를 수신(`read`)하고, `send_msg` 함수를 호출하여 다른 클라이언트에게 메시지를 전달합니다.
7.  클라이언트 접속이 끊어지면 스레드를 종료하고 관련 정보를 정리합니다.

## 3. `iot_client.c` - 클라이언트 프로그램

### 주요 기능

- **서버 접속**: 사용자가 입력한 IP, 포트, ID를 이용해 서버에 접속(`connect`)합니다.
- **송신/수신 분리**: 메시지를 보내는 작업(`send_msg`)과 받는 작업(`recv_msg`)을 별도의 스레드로 분리하여, 메시지를 입력하는 중에도 다른 클라이언트의 메시지를 수신할 수 있습니다.
- **메시지 송수신**:
  - `send_msg` 스레드: 표준 입력(`stdin`)을 `select()`로 감시하다가, 사용자 입력이 있으면 서버로 메시지를 전송(`write`)합니다. `quit` 입력 시 종료합니다.
  - `recv_msg` 스레드: 서버로부터 메시지를 수신(`read`)하여 표준 출력에 표시합니다.

### 실행 흐름

1.  `main` 함수에서 IP, 포트, 이름을 인자로 받아 서버에 접속을 시도합니다.
2.  접속에 성공하면, `[이름:PASSWD]` 형식의 인증 메시지를 서버로 전송합니다.
3.  메시지 송신을 위한 `send_msg` 스레드와 수신을 위한 `recv_msg` 스레드를 각각 생성합니다.
4.  `send_msg` 스레드는 사용자가 `quit`을 입력할 때까지 계속 실행됩니다.
5.  `pthread_join`을 통해 `send_msg` 스레드가 종료되기를 기다린 후, 소켓을 닫고 프로그램을 종료합니다.

## 4. 컴파일 및 실행

### 컴파일

`Makefile`이 제공되므로 `make` 명령어로 간단히 컴파일할 수 있습니다.

```bash
make
```

만약 `Makefile`이 없다면 직접 컴파일합니다.

```bash
# 서버
gcc -o iot_server iot_server.c -lpthread

# 클라이언트
gcc -o iot_client iot_client.c -lpthread
```

### 실행

1.  **서버 실행**

    ```bash
    ./iot_server <Port>
    ```

2.  **클라이언트 실행** (여러 터미널에서 실행 가능)

    ```bash
    ./iot_client <Server_IP> <Server_Port> <Your_ID>
    ```

## 5. 개선점 및 특징

- **하드코딩된 비밀번호**: 클라이언트가 접속 시 보내는 비밀번호가 `PASSWD`로 하드코딩되어 있습니다. 실제 환경에서는 사용자로부터 비밀번호를 입력받아야 합니다.
- **프로토콜**: `[대상ID]메시지` 형태의 간단한 텍스트 기반 프로토콜을 사용합니다. JSON이나 다른 표준 형식으로 확장하면 더 유연한 통신이 가능합니다.
- **MCU 고려**: `iot_server.c` 코드 내에 `#if 0 //for MCU` 와 같은 주석은, 해당 코드가 저사양의 임베디드 장치(MCU) 환경도 일부 고려되었음을 시사합니다.
